<%- include("../../views/partials/user/header") %>

 <!-- <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"> -->
 <style>
  /* General Page Styling */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: #333;
  background-color: #f9f9f9;
}

/* Header & Breadcrumb Enhancement */
.breadcrumbs {
  background-color: #fff;
  padding: 15px 0;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

.breadcrumbs ul li a {
  transition: color 0.3s ease;
}

.breadcrumbs ul li a:hover {
  color: #fe4c50;
  text-decoration: none;
}

/* Card & Container Styling */
.bg-white {
  border-radius: 8px;
  transition: box-shadow 0.3s ease;
}

.bg-white:hover {
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
}

/* Address Cards Enhancements */
.address-cards .card {
  border-radius: 8px;
  transition: all 0.3s ease;
}

.address-cards .card:hover {
  transform: translateY(-3px);
}

.address-cards .card.selected {
  border-width: 2px;
  transform: translateY(-3px);
}

/* Form Elements */
input[type="text"], 
input[type="radio"] {
  cursor: pointer;
}

input[type="text"]::placeholder {
  color: #bbb;
}

/* Buttons Styling */
.btn {
  border-radius: 4px;
  padding: 8px 16px;
  transition: all 0.3s ease;
  font-weight: 500;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.btn-primary, 
.place-order-btn, 
.apply-btn {
  background-color: #663af9 !important;
  border-color: #663af9 !important;
}

.btn-primary:hover, 
.place-order-btn:hover, 
.apply-btn:hover {
  background-color: #5f67fb !important;
  border-color: #5f67fb !important;
}

/* Order Summary Enhancement */
.order-summary {
  border-radius: 8px;
  transition: box-shadow 0.3s ease;
}

.order-summary:hover {
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.product-name {
  font-weight: 500;
}

.product-price, 
.total-price {
  font-size: 1.1em;
}

/* Modal Styling */
.modal-content {
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
}

.modal-header {
  background-color: #f8f9fa;
  border-radius: 8px 8px 0 0;
}

/* Coupon Cards */
.coupon-cards .card {
  transition: all 0.3s ease;
  border-left: 4px solid #4532f4;
}

.coupon-cards .card:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

/* Payment Method Section */
input[name="payment"] {
  margin-right: 10px;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
  .order-summary {
    margin-top: 20px;
  }
  
  .address-cards .card {
    margin-bottom: 15px;
  }
}

/* Badge Styling */
.badge {
  padding: 5px 10px;
  border-radius: 4px;
  font-weight: 500;
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

#couponMessage, 
#appliedCoupon {
  animation: fadeIn 0.5s ease;
}
input[type="radio"] {
    accent-color: #8a4cfe;
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .payment-method label {
    padding: 10px;
    border-radius: 6px;
    transition: background-color 0.3s ease;
    cursor: pointer;
  }

  .payment-method label:hover {
    background-color: #f1f1f1;
  }

  .payment-method img {
    border-radius: 4px;
  }   
     
</style>

 <div class="super-container">
 <div class="banner-area organic-breadcrumb "></div
<body class="bg-light">
    <div class="container py-2">
        
      
        <div class="row">
            <!-- Billing Address -->
<div class="col-lg-8 mb-4">
    <div class="bg-white p-4 rounded shadow-sm">
      
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h4 mb-0">Shipping Address</h2>
            <% if (addresses.length > 0 && addresses[0].address.length > 0) { %>
            <a href="/userProfile" class="btn btn-primary" style="background-color: #fe4c50;color:white">Add New Address</a>
        </div>
        
        <!-- Address Selection Area -->
        <div class="address-cards">
          
            <div class="row"  >
                  <% addresses[0].address.forEach((address, index) => { %>
                        <div  class="col-md-6 mb-3">
                            <div class="card h-100" >
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" 
                                               name="selectedAddress" 
                                               id="address<%= index %>" 
                                               value="<%= address._id %>"
                                               <%= index === 0 ? 'checked' : '' %> >
                                        <label class="form-check-label" for="address<%= index %>">
                                            <span class="badge mb-2" style="background-color:#DAADCC ;">
                                            <%= address.addressType %>
                                          </span>
                                            <h6 class="mb-1"><%= address.name %></h6>
                                            <p class="mb-1 text-muted small">
                                              
                                              <%= address.city %>,<%= address.state %><br>
                                              
                                              <%= address.pincode %> <br>
                                              Phone: <%= address.phone %>  <br>
                                               
                                            </p>
                                        </label>
                                    </div>
                                </div>
                                <a href="/editAddress?id=<%=address._id%>"  style="text-decoration: none; padding-left: 35px;padding-bottom: 5px;"  class="btn-small"   >Edit</a>

                            </div>
                        </div>
                        <% }); %> 
                </div>
                <% } else { %>
                <div class="text-center py-4">
                    <p class="mb-3">No addresses available</p>
                    <a href="/userProfile" class="btn btn-primary">Add Your First Address</a>
                </div>
            <%}%>
        </div>

        <!-- Hidden select for form compatibility -->
        <select id="existingAddress" style="position: absolute; visibility: hidden; opacity: 0; pointer-events: none;">
            <option selected>Select an address</option>
            
                    <option value="">
                        
                    </option>
                
           
        </select>
    </div>
</div>

     <!-- Order Summary -->
            <div  class="col-lg-4">
                <div style="padding: 10px; background-color: white;" class="order-summary">
                    <h2 class="h4 mb-4">Your Order</h2>
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="font-weight-bold">Products</span>
                            <span class="font-weight-bold">Subtotal</span>
                        </div>
                        <% if (cartItems.length > 0) { %>
                          <% cartItems.forEach(item => { %>
                                <div class="d-flex justify-content-between mb-2">
                                    <div class="d-flex align-items-center">
                                        <a style="all: unset; display: contents;" href="/product/<%= item.productId._id %>">
                                          <img style="width: 50px; height: 50px;" src="/uploads/product-images/<%= item.productId.productImage[0] %>" alt="">

                                          <div class="ml-2">
                                            <p class="product-name mb-0"><%= item.productId.name %></p>
                                            <p class="product-mn mb-0"> <%= item.quantity %></p>
                                        </div>
                                    </a>
                                    </div>
                                    <span class="product-price">₹ <%= item.totalPrice %></span>
                                </div>
                           <%})%>
                           <%}else{%>
                            <tr>
                                <td colspan="5" class="text-center">
                                    <p class="lead mb-4">No item found in Cart</p>
                                </td>
                            </tr>
                            <% } %>
                    </div>
                    
                    <div class="border-bottom pb-3 mb-3">
                        <div class="coupon-section mb-4">
                            <h3 class="h5 mb-3">Apply Coupon</h3>
                            <div class="input-group">
                                <input type="text" 
                                id="couponCode"
                                 class="form-control"
                                  placeholder="Enter coupon code">
                                <button class="btn btn-primary" onclick="applyCoupon()">Apply</button>
                                
                            </div>
                            <p id="couponMessage" class="mt-2" style="display: none;"></p>
                            <a href="#" style="text-decoration: none; color: black; font-weight: bold;"  data-bs-toggle="modal" data-bs-target="#couponModal">
                                View Coupons
                              </a>
                        </div>
                    
                        <div id="appliedCoupon" style="display: none;">
                            <p>Applied Coupon: <span id="appliedCouponName" class="text-success"></span></p>
                            <button class="btn btn-sm btn-danger" onclick="removeCoupon()">Remove</button>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
<span>₹ <span id="subtotal"><%= subtotal.toFixed(2) %></span></span>
                        </div>
                       
                        <div class="d-flex justify-content-between mb-2">
                            <span>Coupon Discount</span>
                            <span>(-) ₹ <span id="couponDiscount">0.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping</span>
                            <%if(subtotal<3000){%>
                              <span>₹ 500.00</span>
                              <%}else{%>
                              <span class="text-success">Free Shipping</span>
                              <%}%>
                           
                        </div>
                        <div class="text-right text-primary mb-2">
                            <a href="#" style="text-decoration: none; color: black; font-weight: bold;"   onclick="showShippingCharge(); return false;">View shipping charge</a>
                        </div>
                        <div class="d-flex justify-content-between font-weight-bold">
                            <span>Total</span>
                            <%if(subtotal<3000){%>
                            <span class="total-price">₹ <span id="grandTotal"></span><%= subtotal + 500.00 %></span>
                        <%}else{%>
                            <span class="total-price">₹ <span id="grandTotal"></span><%= subtotal + 0.00 %></span>
                          <%}%>
                          </div>
                    </div>
                    <div class="mb-4">
                      <h3 class="h5 mb-3">Payment Method</h3>
                    
                      <div class="mb-3">
                        <label class="d-flex align-items-center">
                          <input type="radio" name="payment" value="online payment" class="me-2">
                          <img src="/order.jpg" alt="Online Payment" style="height: 20px; width: 100px; object-fit: contain;">
                          <span class="ms-2">Online Payment</span>
                        </label>
                      </div>
                    
                      <div class="mb-3">
                        <label class="d-flex align-items-center">
                          <input type="radio" name="payment" value="wallet" class="me-2">
                          <span class="ms-2">Wallet Payment(<%=wallet?wallet.balance.toFixed(2):'0.00'%>)</span>
                        </label>
                      </div>
                    
                      <div class="mb-3">
                        <label class="d-flex align-items-center">
                          <input type="radio" name="payment" value="cod" class="me-2">
                          <span class="ms-2">Cash on Delivery</span>
                        </label>
                      </div>
                    </div>
                    
                    <button style="color: #f8f9fa;" class="btn place-order-btn btn-block" id="placeOrderBtn" >Place Order</button>
                </div>
            </div>
        </div>
    </div>

 <!-- Coupon Modal -->

 <div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="couponModalLabel">Select a Coupon</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body ">
        <div class="coupon-cards">
          <% if (coupons && coupons.length > 0) { %>
            <div class="row">
              <% coupons.forEach((coupon) => { %>
                <div class="col-12 mb-3"> 
                  <div class="card h-100 shadow-sm border-primary w-100">
                    <div class="card-body d-flex align-items-center">
                      <input
                        class="form-check-input me-3"
                        type="radio"
                        name="selectedCoupon"
                        id="coupon_<%= coupon._id %>"
                        value="<%= coupon._id %>"
                        <% if(coupon.minimumPrice > subtotal) { %>
                          disabled
                        <% } %>
                      />
                      <label class="form-check-label w-100" for="coupon_<%= coupon._id %>">
                        <h6 class="text-primary fw-bold mb-1"><%= coupon.name %></h6>
                        <p class="text-muted mb-1 small">
                          <% if (coupon.offerPrice) { %>
                            <span class="text-success"> <strong><%= coupon.offerPrice %> Off</strong></span> On purchase above <%= coupon.minimumPrice %>
                          
                          <% } %>
                          <br>Expires on <span class="text-warning"><%= new Date(coupon.expireOn).toDateString() %></span>
                          
                          <% if (coupon.minimumPrice > subtotal) { %>
                            <br><span>Add Items worth <strong class="text-danger"><%= coupon.minimumPrice - subtotal %></strong> to available this Offer</span>
                          <% } %>

                          <% if (coupon.discountPercentage && coupon.maxDiscountAmount) { %>
                            <br><span >Max Discount: <strong class="text-danger"><%= coupon.maxDiscountAmount %></strong></span>
                          <% } %>
                        </p>
                      </label>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <div class="text-center py-4">
              <p class="mb-3">No coupons available</p>
            </div>
          <% } %>
        </div>

             
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary mt-2" onclick="clearCouponSelection()">Clear Selection</button>
          <button type="button" class="btn btn-primary" id="applyCouponBtn">Proceed</button>
        </div>
      </div>
    </div>
  </div>
   
<!-- Wallet Payment Modal -->
<div class="modal fade" id="walletPaymentModal" tabindex="-1" aria-labelledby="walletPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="walletPaymentModalLabel">Wallet Payment (<%= wallet ? wallet.balance.toFixed(2) : '0.00' %>)</h5>               
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>Available Balance: ₹<span id="walletBalance"></span></h6>
                    <h6>Payable Amount: ₹<span id="payableAmount"></span></h6>
                </div>
                <div id="insufficientFunds" style="display: none;">
                    <div class="alert alert-warning">
                        Insufficient funds in wallet. Please add money to continue.
                    </div>
                    <a href="/wallet#add-money-button" class="btn btn-primary">Add Money</a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" >Close</button>
                <button type="button" class="btn btn-primary" id="confirmWalletPayment">Pay Now</button>
            </div>
        </div>
    </div>
</div>
</div>

    
<script>
  // Update the hidden select when a card is selected
  document.querySelectorAll('input[name="selectedAddress"]').forEach(radio => {
      radio.addEventListener('change', function() {
          // Update the hidden select
          document.getElementById('existingAddress').value = this.value;
          
          // Update card styling
          document.querySelectorAll('.address-cards .card').forEach(card => {
              card.classList.remove('selected');
          });
          this.closest('.card').classList.add('selected');
      });
  });
</script>
          
          <script>
              // JavaScript to handle the "Add New Address" button click
              document.getElementById('addNewAddressBtn').addEventListener('click', function() {
                  document.getElementById('newAddressForm').style.display = 'block';
              });
          </script>
     

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

<script>
                        //place order

document.getElementById('placeOrderBtn').addEventListener('click', function (e) {
    e.preventDefault(); // Always prevent default

    const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
    const selectedPayment = document.querySelector('input[name="payment"]:checked');

    if (!selectedAddress) {
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Please select a shipping address!',
            confirmButtonColor: '#fe4c50',
        });
        return;
    }

    if (!selectedPayment) {
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Please select a payment method!',
            confirmButtonColor: '#fe4c50',
        });
        return;
    }

    // Submit form to backend
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/placeOrder'; // your backend route

    const addressInput = document.createElement('input');
    addressInput.type = 'hidden';
    addressInput.name = 'addressId';
    addressInput.value = selectedAddress.value;

    const paymentInput = document.createElement('input');
    paymentInput.type = 'hidden';
    paymentInput.name = 'paymentMethod';
    paymentInput.value = selectedPayment.value;

    form.appendChild(addressInput);
    form.appendChild(paymentInput);

    document.body.appendChild(form);
    form.submit(); // This will go to your backend and render a new page
});


//github

function processCODOrder(orderData) {
   fetch('/placeOrder', {
       method: 'POST',
       headers: {
           'Content-Type': 'application/json',
       },
       body: JSON.stringify(orderData)
   })
   .then(response => response.json())
   .then(data => {
       console.log("Response from server:", data); 
       if (data.success) {
           Swal.fire({
               title: 'Order Placed Successfully!',
               icon: 'success',
              showConfirmButton: false,
              timer:1500,
           }).then((result) => {
                   window.location.href = '/confirmation';    
           });
       } else {
           Swal.fire('Error', data.message || 'An error occurred while placing the order', 'error');
       }
   })
   .catch(error => {
       console.error('Error:', error);
       Swal.fire('Error', 'An error occurred while placing the order', 'error');
   });
}

                 //clearing selected coupons

function clearCouponSelection() {
    const selectedRadio = document.querySelector('input[name="selectedCoupon"]:checked');
    if (selectedRadio) {
        selectedRadio.checked = false;
    }
}

                //apply coupons

document.getElementById("applyCouponBtn").addEventListener("click", function () {
    const selectedCoupon = document.querySelector('input[name="selectedCoupon"]:checked');
    const couponModal = document.getElementById("couponModal");
    const modalInstance = bootstrap.Modal.getInstance(couponModal);

    if (selectedCoupon) {
        const couponLabel = document.querySelector(`label[for="${selectedCoupon.id}"] h6`).textContent;
        document.getElementById("couponCode").value = couponLabel;
    }

    if (modalInstance) {
        modalInstance.hide();
    }

    setTimeout(() => {
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    document.body.classList.remove("modal-open");
    document.body.style.overflow = "";
}, 200);
});
let appliedCoupon = null;

function applyCoupon() {
   const couponCode = document.getElementById('couponCode').value;
   const subtotalText = document.getElementById('subtotal').textContent.trim();
const subtotal = parseFloat(subtotalText.replace(/[^\d.]/g, ''));

   fetch('/applyCoupon', {
       method: 'POST',
       headers: {
           'Content-Type': 'application/json',
       },
       body: JSON.stringify({ couponCode, subtotal }),
   })
   .then(response => response.json())
   .then(data => {
       const messageElement = document.getElementById('couponMessage');
       if (data.success) {
           appliedCoupon = data.coupon;
           updateOrderSummary();
           messageElement.textContent = 'Coupon applied successfully!';
           messageElement.style.color = 'green';
           document.getElementById('appliedCoupon').style.display = 'block';
           document.getElementById('appliedCouponName').textContent = data.coupon.name;
           document.querySelector('.coupon-section').style.display = 'none';
           Swal.fire('success', `coupon ${data.coupon.name} applied successfully`, 'success');
       } else {
           messageElement.textContent = data.message;
           messageElement.style.color = 'red';
       }
       messageElement.style.display = 'block';
   })
   .catch(error => {
       console.error('Error:', error);
       Swal.fire('Error', 'An error occurred while applying the coupon', 'error');
   });
}

function updateOrderSummary() {
    const subtotalElement = document.getElementById('subtotal');
    const couponDiscountElement = document.getElementById('couponDiscount');
    const grandTotalElement = document.getElementById('grandTotal');

    const subtotal = parseFloat(subtotalElement.textContent);
    let discount = 0;

    if (appliedCoupon) {

        if (appliedCoupon.discountPercentage) {

            discount = (subtotal * appliedCoupon.discountPercentage) / 100;

            if (appliedCoupon.maxDiscountAmount && discount > appliedCoupon.maxDiscountAmount) {
                discount = appliedCoupon.maxDiscountAmount;
            }
        } else {

            discount = appliedCoupon.offerPrice;
        }
    }

    let grandTotal;

    if (subtotal < 3000) {
        grandTotal = subtotal - discount + 500;
    } else {
        grandTotal = subtotal - discount;
    }

    couponDiscountElement.textContent = discount.toFixed(2);
    grandTotalElement.textContent = grandTotal.toFixed(2);
}





    
</script>

<%- include("../../views/partials/user/footer") %>